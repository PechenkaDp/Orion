{% if user_role == 'safety_specialist' or user_role == 'admin' %}
<div class="dashboard-card critical-risks-card" id="criticalRisksCard">
    <div class="card-header">
        <div class="card-icon">‚ö†Ô∏è</div>
        –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏
        <span class="risk-counter" id="criticalRisksCounter">0</span>
    </div>
    
    <div class="critical-risks-list" id="criticalRisksList">
        <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏ -->
        <div class="loader">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    </div>
    
    <div class="card-actions">
        <a href="{% url 'evacuation_create' %}" class="action-btn evacuation-btn">
            <span class="btn-icon">üö®</span> –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —ç–≤–∞–∫—É–∞—Ü–∏–∏
        </a>
    </div>
</div>

<style>
    .critical-risks-card {
        position: relative;
        overflow: hidden;
    }
    
    .critical-risks-card.alert-active {
        animation: risk-alert 1.5s infinite;
    }
    
    @keyframes risk-alert {
        0% { box-shadow: 0 0 5px rgba(244, 67, 54, 0.5); }
        50% { box-shadow: 0 0 20px rgba(244, 67, 54, 0.8); }
        100% { box-shadow: 0 0 5px rgba(244, 67, 54, 0.5); }
    }
    
    .risk-counter {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 20px;
        height: 20px;
        padding: 0 6px;
        background-color: #f44336;
        color: white;
        border-radius: 10px;
        font-size: 12px;
        margin-left: 8px;
    }
    
    .critical-risks-list {
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 15px;
    }
    
    .risk-item {
        padding: 10px;
        margin-bottom: 8px;
        background-color: #fff5f5;
        border-left: 3px solid #f44336;
        border-radius: 4px;
    }
    
    .risk-item.high {
        background-color: #fff5e6;
        border-left-color: #ff9800;
    }
    
    .risk-item.critical {
        background-color: #ffe6e6;
        border-left-color: #f44336;
    }
    
    .risk-title {
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .risk-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 13px;
        color: #666;
    }
    
    .risk-actions {
        display: flex;
        justify-content: space-between;
    }
    
    .loader {
        text-align: center;
        padding: 20px;
        color: #666;
    }
    
    .evacuation-btn {
        background-color: #f44336;
        width: 100%;
        text-align: center;
        margin-top: 10px;
    }
    
    .evacuation-btn:hover {
        background-color: #d32f2f;
    }
    
    .btn-icon {
        margin-right: 5px;
    }
    
    .no-risks {
        text-align: center;
        padding: 20px;
        color: #4caf50;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–∏—Å–∫–æ–≤
        function fetchCriticalRisks() {
            fetch('{% url "api_critical_risks" %}')
                .then(response => response.json())
                .then(data => {
                    const risksList = document.getElementById('criticalRisksList');
                    const risksCounter = document.getElementById('criticalRisksCounter');
                    const risksCard = document.getElementById('criticalRisksCard');
                    
                    // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                    risksList.innerHTML = '';
                    
                    if (data.has_critical_risks) {
                        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –æ–ø–æ–≤–µ—â–µ–Ω–∏—è
                        risksCard.classList.add('alert-active');
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
                        risksCounter.textContent = data.critical_risks.length;
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∏—Å–∫–∏ –≤ —Å–ø–∏—Å–æ–∫
                        data.critical_risks.forEach(risk => {
                            const riskItem = document.createElement('div');
                            riskItem.className = `risk-item ${risk.level}`;
                            
                            riskItem.innerHTML = `
                                <div class="risk-title">${risk.hazard_name}</div>
                                <div class="risk-info">
                                    <span>–£—Ä–æ–≤–µ–Ω—å: ${risk.level === 'high' ? '–í—ã—Å–æ–∫–∏–π' : '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π'}</span>
                                    <span>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ: ${risk.department}</span>
                                </div>
                                <div class="risk-info">
                                    <span>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: ${risk.location || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
                                    <span>–û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞: ${risk.risk_score}</span>
                                </div>
                                <div class="risk-actions">
                                    <a href="/risks/${risk.id}/" class="action-btn">–ü—Ä–æ—Å–º–æ—Ç—Ä</a>
                                    <button class="action-btn" onclick="resolveRisk(${risk.id})">–£—Å—Ç—Ä–∞–Ω–µ–Ω–æ</button>
                                </div>
                            `;
                            
                            risksList.appendChild(riskItem);
                        });
                    } else {
                        // –û—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é, –µ—Å–ª–∏ –Ω–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–∏—Å–∫–æ–≤
                        risksCard.classList.remove('alert-active');
                        risksCounter.textContent = '0';
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ä–∏—Å–∫–æ–≤
                        risksList.innerHTML = '<div class="no-risks">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</div>';
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–∏—Å–∫–æ–≤:', error);
                    document.getElementById('criticalRisksList').innerHTML = 
                        '<div class="loader">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö</div>';
                });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è —Ä–∏—Å–∫–∞
        window.resolveRisk = function(riskId) {
            fetch(`/risks/${riskId}/resolve/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ä–∏—Å–∫–æ–≤
                    fetchCriticalRisks();
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–∏—Å–∫–∞:', error);
            });
        };
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        fetchCriticalRisks();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(fetchCriticalRisks, 30000);
    });
</script>
{% endif %}