{% extends 'base.html' %}
{% load static %}

{% block title %}–†–∏—Å–∫ #{{ risk.id }} | –û—Ä–∏–æ–Ω{% endblock %}

{% block content %}
<div class="page-header">
    <h1>–†–∏—Å–∫ #{{ risk.id }} - {{ risk.hazard.name }}</h1>
    <div class="action-buttons">
        <a href="{% url 'risk_update' risk.id %}" class="action-btn">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
        <a href="{% url 'risk_delete' risk.id %}" class="action-btn btn-danger">–£–¥–∞–ª–∏—Ç—å</a>
    </div>
</div>

<div class="detail-container">
    <div class="detail-card">
        <div class="detail-header">
            <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∏—Å–∫–µ</h2>
            <span class="status-badge {% if risk.level == 'low' %}status-low{% elif risk.level == 'medium' %}status-medium{% elif risk.level == 'high' %}status-high{% elif risk.level == 'critical' %}status-critical{% endif %}">
                {% if risk.level == 'low' %}–ù–∏–∑–∫–∏–π{% elif risk.level == 'medium' %}–°—Ä–µ–¥–Ω–∏–π{% elif risk.level == 'high' %}–í—ã—Å–æ–∫–∏–π{% elif risk.level == 'critical' %}–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π{% endif %}
            </span>
        </div>
        
        <div class="detail-content">
            <div class="detail-row">
                <div class="detail-label">–û–ø–∞—Å–Ω–æ—Å—Ç—å:</div>
                <div class="detail-value">{{ risk.hazard.name }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</div>
                <div class="detail-value">{{ risk.hazard.category }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</div>
                <div class="detail-value">{{ risk.department.name }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</div>
                <div class="detail-value">{{ risk.location }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å:</div>
                <div class="detail-value">{{ risk.probability }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">–¢—è–∂–µ—Å—Ç—å –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–π:</div>
                <div class="detail-value">{{ risk.severity }} –∏–∑ 10</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">–û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞:</div>
                <div class="detail-value"><strong>{{ risk.risk_score }}</strong></div>
            </div>
            <div class="detail-row">
                <div class="detail-label">–î–∞—Ç–∞ –æ—Ü–µ–Ω–∫–∏:</div>
                <div class="detail-value">{{ risk.evaluation_date|date:"d.m.Y" }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">–û—Ü–µ–Ω–∏–ª:</div>
                <div class="detail-value">{{ risk.evaluated_by }}</div>
            </div>
            {% if risk.description %}
            <div class="detail-row">
                <div class="detail-label">–û–ø–∏—Å–∞–Ω–∏–µ:</div>
                <div class="detail-value">{{ risk.description }}</div>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="detail-card">
        <div class="detail-header">
            <h2>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –ø–æ —Å–Ω–∏–∂–µ–Ω–∏—é —Ä–∏—Å–∫–∞</h2>
            <a href="{% url 'risk_mitigation_add' risk.id %}" class="action-btn">–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</a>
        </div>
        <div class="detail-content">
            <table class="detail-table">
                <thead>
                    <tr>
                        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                        <th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th>
                        <th>–°—Ä–æ–∫</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for measure in mitigation_measures %}
                    <tr>
                        <td>{{ measure.description }}</td>
                        <td>{{ measure.responsible_person }}</td>
                        <td>{{ measure.deadline|date:"d.m.Y" }}</td>
                        <td>
                            <span class="status-badge {% if measure.status == 'new' %}status-pending{% elif measure.status == 'in_progress' %}status-pending{% elif measure.status == 'completed' %}status-completed{% elif measure.status == 'canceled' %}status-urgent{% endif %}">
                                {% if measure.status == 'new' %}–ù–æ–≤–∞—è{% elif measure.status == 'in_progress' %}–í —Ä–∞–±–æ—Ç–µ{% elif measure.status == 'completed' %}–í—ã–ø–æ–ª–Ω–µ–Ω–æ{% elif measure.status == 'canceled' %}–û—Ç–º–µ–Ω–µ–Ω–æ{% endif %}
                            </span>
                        </td>
                        <td>{% if measure.effectiveness_rating %}{{ measure.effectiveness_rating }} –∏–∑ 10{% else %}–ù–µ –æ—Ü–µ–Ω–µ–Ω–∞{% endif %}</td>
                        <td>
                            <a href="{% url 'risk_mitigation_update' measure.id %}" class="icon-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"><span class="btn-icon">‚úèÔ∏è</span></a>
                            <a href="{% url 'risk_mitigation_delete' measure.id %}" class="icon-btn" title="–£–¥–∞–ª–∏—Ç—å"><span class="btn-icon">üóëÔ∏è</span></a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="empty-table">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="detail-card">
        <div class="detail-header">
            <h2>–û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞</h2>
        </div>
        <div class="detail-content risk-matrix">
            <div class="risk-matrix-container">
                <table class="risk-matrix-table">
                    <thead>
                        <tr>
                            <th></th>
                            <th colspan="5">–¢—è–∂–µ—Å—Ç—å –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–π</th>
                        </tr>
                        <tr>
                            <th>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å</th>
                            <th>–ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–∞—è (1-2)</th>
                            <th>–ù–∏–∑–∫–∞—è (3-4)</th>
                            <th>–°—Ä–µ–¥–Ω—è—è (5-6)</th>
                            <th>–í—ã—Å–æ–∫–∞—è (7-8)</th>
                            <th>–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è (9-10)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>–û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è (0.8-1.0)</td>
                            <td class="risk-low">–ù–∏–∑–∫–∏–π</td>
                            <td class="risk-medium">–°—Ä–µ–¥–Ω–∏–π</td>
                            <td class="risk-high">–í—ã—Å–æ–∫–∏–π</td>
                            <td class="risk-critical">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π</td>
                            <td class="risk-critical">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π</td>
                        </tr>
                        <tr>
                            <td>–í—ã—Å–æ–∫–∞—è (0.6-0.8)</td>
                            <td class="risk-low">–ù–∏–∑–∫–∏–π</td>
                            <td class="risk-medium">–°—Ä–µ–¥–Ω–∏–π</td>
                            <td class="risk-high">–í—ã—Å–æ–∫–∏–π</td>
                            <td class="risk-high">–í—ã—Å–æ–∫–∏–π</td>
                            <td class="risk-critical">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π</td>
                        </tr>
                        <tr>
                            <td>–°—Ä–µ–¥–Ω—è—è (0.4-0.6)</td>
                            <td class="risk-low">–ù–∏–∑–∫–∏–π</td>
                            <td class="risk-medium">–°—Ä–µ–¥–Ω–∏–π</td>
                            <td class="risk-medium">–°—Ä–µ–¥–Ω–∏–π</td>
                            <td class="risk-high">–í—ã—Å–æ–∫–∏–π</td>
                            <td class="risk-high">–í—ã—Å–æ–∫–∏–π</td>
                        </tr>
                        <tr>
                            <td>–ù–∏–∑–∫–∞—è (0.2-0.4)</td>
                            <td class="risk-low">–ù–∏–∑–∫–∏–π</td>
                            <td class="risk-low">–ù–∏–∑–∫–∏–π</td>
                            <td class="risk-medium">–°—Ä–µ–¥–Ω–∏–π</td>
                            <td class="risk-medium">–°—Ä–µ–¥–Ω–∏–π</td>
                            <td class="risk-high">–í—ã—Å–æ–∫–∏–π</td>
                        </tr>
                        <tr>
                            <td>–û—á–µ–Ω—å –Ω–∏–∑–∫–∞—è (0.0-0.2)</td>
                            <td class="risk-low">–ù–∏–∑–∫–∏–π</td>
                            <td class="risk-low">–ù–∏–∑–∫–∏–π</td>
                            <td class="risk-low">–ù–∏–∑–∫–∏–π</td>
                            <td class="risk-medium">–°—Ä–µ–¥–Ω–∏–π</td>
                            <td class="risk-medium">–°—Ä–µ–¥–Ω–∏–π</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="current-risk-marker" id="riskMarker" style="top: {{ risk_marker_top }}px; left: {{ risk_marker_left }}px;" title="–¢–µ–∫—É—â–∏–π —Ä–∏—Å–∫">
                    <span class="marker-icon">üìç</span>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .status-low {
        background-color: #e6f7e6;
        color: #4caf50;
    }
    .status-medium {
        background-color: #fff5e6;
        color: #ff9800;
    }
    .status-high {
        background-color: #ffe6e6;
        color: #f44336;
    }
    .status-critical {
        background-color: #9c0006;
        color: white;
    }
    
    .risk-matrix-container {
        position: relative;
        overflow: hidden;
    }
    
    .risk-matrix-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .risk-matrix-table th, 
    .risk-matrix-table td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: center;
    }
    
    .risk-low {
        background-color: #e6f7e6;
    }
    
    .risk-medium {
        background-color: #fff5e6;
    }
    
    .risk-high {
        background-color: #ffe6e6;
    }
    
    .risk-critical {
        background-color: #9c0006;
        color: white;
    }
    
    .current-risk-marker {
        position: absolute;
        font-size: 24px;
        color: red;
        z-index: 10;
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const probability = {{ risk.probability }};
        const severity = {{ risk.severity }};

        const table = document.querySelector('.risk-matrix-table');
        const tableRect = table.getBoundingClientRect();
        const tableWidth = tableRect.width - 120;
        const tableHeight = tableRect.height - 80;

        const markerLeft = 120 + (tableWidth / 10) * severity;
        const markerTop = 80 + tableHeight - (tableHeight / 5) * (probability * 5);

        const marker = document.getElementById('riskMarker');
        marker.style.left = markerLeft + 'px';
        marker.style.top = markerTop + 'px';
    });
</script>
{% endblock %}