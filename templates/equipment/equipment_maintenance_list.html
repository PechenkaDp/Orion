{% extends 'base.html' %}
{% load static %}
{% block title %}–ò—Å—Ç–æ—Ä–∏—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è | –û—Ä–∏–æ–Ω{% endblock %}
{% block content %}
<div class="page-header">
    <h1>–ò—Å—Ç–æ—Ä–∏—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h1>
</div>
<div class="filter-bar">
    <form method="get" action="{% url 'equipment_maintenance_list' %}">
        <div class="filter-group">
            <label for="equipment">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ:</label>
            <select name="equipment" id="equipment" class="form-control" onchange="this.form.submit()">
                <option value="">–í—Å–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</option>
                {% for item in equipment_items %}
                <option value="{{ item.id }}" {% if equipment_filter == item.id|stringformat:"i" %}selected{% endif %}>{{ item.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="maintenance_type">–¢–∏–ø –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è:</label>
            <select name="maintenance_type" id="maintenance_type" class="form-control" onchange="this.form.submit()">
                <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                {% for type in maintenance_types %}
                <option value="{{ type }}" {% if type_filter == type %}selected{% endif %}>{{ type }}</option>
                {% endfor %}
            </select>
        </div>
    </form>
</div>
<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>–î–∞—Ç–∞</th>
                <th>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</th>
                <th>–¢–∏–ø –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è</th>
                <th>–í—ã–ø–æ–ª–Ω–∏–ª</th>
                <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                <th>–°–ª–µ–¥—É—é—â–µ–µ –¢–û</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for record in page_obj %}
            <tr>
                <td>{{ record.maintenance_date|date:"d.m.Y" }}</td>
                <td>{{ record.equipment.name }}</td>
                <td>{{ record.maintenance_type }}</td>
                <td>{{ record.performed_by.last_name }} {{ record.performed_by.first_name }}</td>
                <td>{{ record.result }}</td>
                <td>
                    {{ record.next_maintenance_date|date:"d.m.Y"|default:"–ù–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ" }}
                    {% if record.next_maintenance_date and record.next_maintenance_date < current_date %}
                    <span class="status-badge status-urgent">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>
                    {% endif %}
                </td>
                <td>
                    <a href="{% url 'maintenance_detail' record.id %}" class="icon-btn" title="–ü—Ä–æ—Å–º–æ—Ç—Ä"><span class="btn-icon">üëÅÔ∏è</span></a>
                    <a href="{% url 'maintenance_update' record.id %}" class="icon-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"><span class="btn-icon">‚úèÔ∏è</span></a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" class="empty-table">–ó–∞–ø–∏—Å–∏ –æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% include 'partials/pagination.html' with page=page_obj %}
<div class="section-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è</div>
<div class="dashboard-grid">
    <div class="dashboard-card">
        <div class="card-header">
            <div class="card-icon">üîß</div>
            –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º
        </div>
        <div class="chart-container">
            <canvas id="maintenanceTypesChart"></canvas>
        </div>
    </div>
    <div class="dashboard-card">
    <div class="card-header">
        <div class="card-icon">üìä</div>
        –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –ø–æ –º–µ—Å—è—Ü–∞–º
    </div>
    <div class="chart-container">
        <canvas id="maintenanceMonthsChart"></canvas>
    </div>
</div>

<div class="dashboard-card">
    <div class="card-header">
        <div class="card-icon">‚ö†Ô∏è</div>
        –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ, —Ç—Ä–µ–±—É—é—â–µ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
    </div>
    <div class="detail-content">
        <ul class="dashboard-list">
            {% for item in equipment_needs_maintenance %}
            <li>
                <a href="{% url 'equipment_detail' item.id %}">
                    {{ item.name }}
                    <span class="list-date {% if item.next_maintenance_date and item.next_maintenance_date < current_date %}overdue{% endif %}">
                        {{ item.next_maintenance_date|date:"d.m.Y"|default:"–ù–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ" }}
                    </span>
                </a>
            </li>
            {% empty %}
            <li>–ù–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, —Ç—Ä–µ–±—É—é—â–µ–≥–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è</li>
            {% endfor %}
        </ul>
    </div>
</div>
</div>
<style>
    .chart-container {
        height: 300px;
        position: relative;
    }

    .overdue {
        color: #f44336;
        font-weight: bold;
    }
</style>
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // –î–∏–∞–≥—Ä–∞–º–º–∞ —Ç–∏–ø–æ–≤ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
        var typesCtx = document.getElementById('maintenanceTypesChart').getContext('2d');
        var typesChart = new Chart(typesCtx, {
            type: 'pie',
            data: {
                labels: {{ maintenance_types_stats_labels|safe }},
                datasets: [{
                    data: {{ maintenance_types_stats_data|safe }},
                    backgroundColor: [
                        '#4caf50', '#ff9800', '#2196f3', '#f44336', '#9c27b0', '#e91e63'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });

        // –î–∏–∞–≥—Ä–∞–º–º–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º
        var monthsCtx = document.getElementById('maintenanceMonthsChart').getContext('2d');
        var monthsChart = new Chart(monthsCtx, {
            type: 'bar',
            data: {
                labels: {{ maintenance_months_labels|safe }},
                datasets: [{
                    label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–π',
                    data: {{ maintenance_months_data|safe }},
                    backgroundColor: '#ff7a00'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}
{% endblock %}