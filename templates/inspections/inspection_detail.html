{% extends 'base.html' %}
{% load static %}

{% block title %}–ü—Ä–æ–≤–µ—Ä–∫–∞: {{ inspection.title }} | –û—Ä–∏–æ–Ω{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ inspection.title }}</h1>
    <div class="action-buttons">
        <a href="{% url 'inspection_update' inspection.id %}" class="action-btn">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
        <a href="{% url 'inspection_finding_create' inspection.id %}" class="action-btn">–î–æ–±–∞–≤–∏—Ç—å –Ω–∞—Ä—É—à–µ–Ω–∏–µ</a>
        <a href="{% url 'inspection_delete' inspection.id %}" class="action-btn btn-danger">–£–¥–∞–ª–∏—Ç—å</a>
    </div>
</div>

<div class="detail-container">
    <div class="detail-card">
        <div class="detail-header">
            <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–≤–µ—Ä–∫–µ</h2>
            <span class="status-badge {% if inspection.status == 'new' %}status-pending{% elif inspection.status == 'in_progress' %}status-pending{% elif inspection.status == 'completed' %}status-completed{% elif inspection.status == 'canceled' %}status-urgent{% endif %}">
                {% if inspection.status == 'new' %}–ù–æ–≤–∞—è{% elif inspection.status == 'in_progress' %}–í –ø—Ä–æ—Ü–µ—Å—Å–µ{% elif inspection.status == 'completed' %}–ó–∞–≤–µ—Ä—à–µ–Ω–∞{% elif inspection.status == 'canceled' %}–û—Ç–º–µ–Ω–µ–Ω–∞{% endif %}
            </span>
        </div>
        
        <div class="detail-content">
            <div class="detail-row">
                <div class="detail-label">–¢–∏–ø –ø—Ä–æ–≤–µ—Ä–∫–∏:</div>
                <div class="detail-value">{{ inspection.inspection_type }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</div>
                <div class="detail-value">{{ inspection.department.name }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</div>
                <div class="detail-value">{{ inspection.start_date|date:"d.m.Y H:i" }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</div>
                <div class="detail-value">{{ inspection.end_date|date:"d.m.Y H:i"|default:"–ù–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞" }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">–í–µ–¥—É—â–∏–π –ø—Ä–æ–≤–µ—Ä—è—é—â–∏–π:</div>
                <div class="detail-value">{{ inspection.lead_inspector.last_name }} {{ inspection.lead_inspector.first_name }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">–û–ø–∏—Å–∞–Ω–∏–µ:</div>
                <div class="detail-value">{{ inspection.description|default:"–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è" }}</div>
            </div>
            {% if inspection.status == 'completed' %}
            <div class="detail-row">
                <div class="detail-label">–†–µ–∑—É–ª—å—Ç–∞—Ç:</div>
                <div class="detail-value">{{ inspection.result|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}</div>
            </div>
            {% endif %}
            {% if inspection.report_path %}
            <div class="detail-row">
                <div class="detail-label">–û—Ç—á–µ—Ç:</div>
                <div class="detail-value">
                    <a href="{{ inspection.report_path }}" class="file-link" target="_blank">–°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç</a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="detail-card">
        <div class="detail-header">
            <h2>–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è</h2>
            <a href="{% url 'inspection_finding_create' inspection.id %}" class="action-btn">–î–æ–±–∞–≤–∏—Ç—å –Ω–∞—Ä—É—à–µ–Ω–∏–µ</a>
        </div>
        <div class="detail-content">
            <table class="detail-table">
                <thead>
                    <tr>
                        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                        <th>–¢—è–∂–µ—Å—Ç—å</th>
                        <th>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</th>
                        <th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th>
                        <th>–°—Ä–æ–∫ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for finding in findings %}
                    <tr>
                        <td>{{ finding.description }}</td>
                        <td>
                            <span class="severity-badge severity-{{ finding.severity|lower }}">
                                {{ finding.severity }}
                            </span>
                        </td>
                        <td>{{ finding.location }}</td>
                        <td>{{ finding.responsible_department.name }}</td>
                        <td>{{ finding.deadline|date:"d.m.Y" }}</td>
                        <td>
                            <span class="status-badge {% if finding.status == 'new' %}status-pending{% elif finding.status == 'in_progress' %}status-pending{% elif finding.status == 'completed' %}status-completed{% elif finding.status == 'canceled' %}status-urgent{% endif %}">
                                {% if finding.status == 'new' %}–ù–æ–≤–æ–µ{% elif finding.status == 'in_progress' %}–í —Ä–∞–±–æ—Ç–µ{% elif finding.status == 'completed' %}–£—Å—Ç—Ä–∞–Ω–µ–Ω–æ{% elif finding.status == 'canceled' %}–û—Ç–º–µ–Ω–µ–Ω–æ{% endif %}
                            </span>
                        </td>
                        <td>
                            <a href="{% url 'inspection_finding_update' finding.id %}" class="icon-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"><span class="btn-icon">‚úèÔ∏è</span></a>
                            <a href="{% url 'inspection_finding_delete' finding.id %}" class="icon-btn" title="–£–¥–∞–ª–∏—Ç—å"><span class="btn-icon">üóëÔ∏è</span></a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="empty-table">–ù–∞—Ä—É—à–µ–Ω–∏—è –Ω–µ –≤—ã—è–≤–ª–µ–Ω—ã</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% if inspection.status != 'completed' and inspection.status != 'canceled' %}
    <div class="detail-card">
        <div class="detail-header">
            <h2>–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏</h2>
        </div>
        <div class="detail-content">
            <form method="post" action="{% url 'inspection_complete' inspection.id %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-group">
                    <label for="end_date">–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</label>
                    <input type="datetime-local" id="end_date" name="end_date" class="form-control" value="{% now 'Y-m-d\TH:i' %}" required>
                </div>
                <div class="form-group">
                    <label for="result">–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</label>
                    <textarea id="result" name="result" class="form-control" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="report">–û—Ç—á–µ—Ç –æ –ø—Ä–æ–≤–µ—Ä–∫–µ</label>
                    <input type="file" id="report" name="report" class="form-control">
                </div>
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="status">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</label>
                        <select name="status" id="status" class="form-control">
                            <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</option>
                            <option value="canceled">–û—Ç–º–µ–Ω–µ–Ω–∞</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="action-btn">–ó–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É</button>
            </form>
        </div>
    </div>
    {% endif %}
</div>

<style>
    .severity-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
    }
    
    .severity-low {
        background-color: #e6f7e6;
        color: #4caf50;
    }
    
    .severity-medium {
        background-color: #fff5e6;
        color: #ff9800;
    }
    
    .severity-high {
        background-color: #ffe6e6;
        color: #f44336;
    }
    
    .severity-critical {
        background-color: #9c0006;
        color: white;
    }
    
    .file-link {
        color: #ff7a00;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
    }
    
    .file-link:hover {
        text-decoration: underline;
    }
    
    .file-link:before {
        content: 'üìÑ';
        margin-right: 5px;
    }
</style>
{% endblock %}