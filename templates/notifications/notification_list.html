{% extends 'base.html' %}
{% load static %}

{% block title %}–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è | –û—Ä–∏–æ–Ω{% endblock %}

{% block content %}
<div class="page-header">
    <h1>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h1>
    <div class="action-buttons">
        <a href="#" class="action-btn" id="markAllReadBtn">–û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ</a>
    </div>
</div>

<div class="filter-bar">
    <form method="get" action="{% url 'notifications' %}">
        <div class="filter-group">
            <label for="is_read">–ü–æ–∫–∞–∑–∞—Ç—å:</label>
            <select name="is_read" id="is_read" class="form-control" onchange="this.form.submit()">
                <option value="">–í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</option>
                <option value="0" {% if is_read_filter == '0' %}selected{% endif %}>–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ</option>
                <option value="1" {% if is_read_filter == '1' %}selected{% endif %}>–ü—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ</option>
            </select>
        </div>
    </form>
</div>

<div class="notification-list">
    {% for notification in page_obj %}
    <div class="notification-item {% if not notification.is_read %}unread{% endif %}" data-id="{{ notification.id }}">
        <div class="notification-icon">
            {% if notification.notification_type == 'task' %}üìã
            {% elif notification.notification_type == 'instruction' %}üìù
            {% elif notification.notification_type == 'ppe' %}üë∑
            {% elif notification.notification_type == 'inspection' %}üîç
            {% elif notification.notification_type == 'medical' %}üè•
            {% elif notification.notification_type == 'equipment' %}üîß
            {% elif notification.notification_type == 'risk' %}‚ö†Ô∏è
            {% else %}üì¢
            {% endif %}
        </div>
        <div class="notification-content">
            <div class="notification-header">
                <div class="notification-title">{{ notification.title }}</div>
                <div class="notification-time">{{ notification.created_at|date:"d.m.Y H:i" }}</div>
            </div>
            <div class="notification-message">{{ notification.message }}</div>
            {% if notification.related_entity_type %}
            <div class="notification-link">
                {% if notification.related_entity_type == 'medical_examination' %}
                    <a href="{% url 'medical_exam_detail' notification.related_entity_id %}">–ü–µ—Ä–µ–π—Ç–∏ –∫ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–º—É –æ—Å–º–æ—Ç—Ä—É</a>
                {% elif notification.related_entity_type == 'employee' %}
                    <a href="{% url 'employee_detail' notification.related_entity_id %}">–ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É</a>
                {% elif notification.related_entity_type == 'ppe' or notification.related_entity_type == 'ppe_request' %}
                    <a href="{% url 'ppe_detail' notification.related_entity_id %}">–ü–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞—è–≤–∫–µ –°–ò–ó</a>
                {% elif notification.related_entity_type == 'instruction' %}
                    <a href="{% url 'instruction_detail' notification.related_entity_id %}">–ü–µ—Ä–µ–π—Ç–∏ –∫ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂—É</a>
                {% elif notification.related_entity_type == 'document' %}
                    <a href="{% url 'document_detail' notification.related_entity_id %}">–ü–µ—Ä–µ–π—Ç–∏ –∫ –¥–æ–∫—É–º–µ–Ω—Ç—É</a>
                {% elif notification.related_entity_type == 'risk' %}
                    <a href="{% url 'risk_detail' notification.related_entity_id %}">–ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–∏—Å–∫—É</a>
                {% elif notification.related_entity_type == 'inspection' %}
                    <a href="{% url 'inspection_detail' notification.related_entity_id %}">–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ</a>
                {% elif notification.related_entity_type == 'equipment' %}
                    <a href="{% url 'equipment_detail' notification.related_entity_id %}">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é</a>
                {% else %}
                    <a href="#">–ü–µ—Ä–µ–π—Ç–∏ –∫ {{ notification.related_entity_type }}</a>
                {% endif %}
            </div>
            {% endif %}
        </div>
        <div class="notification-actions">
            {% if not notification.is_read %}
            <a href="#" class="mark-read-btn icon-btn" data-id="{{ notification.id }}" title="–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ"><span class="btn-icon">‚úì</span></a>
            {% else %}
            <span class="read-indicator" title="–ü—Ä–æ—á–∏—Ç–∞–Ω–æ">‚úì</span>
            {% endif %}
        </div>
    </div>
    {% empty %}
    <div class="empty-notification">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
    {% endfor %}
</div>

{% include 'partials/pagination.html' with page=page_obj %}

<style>
    .notification-list {
        margin-bottom: 20px;
    }

    .notification-item {
        display: flex;
        background-color: white;
        border-radius: 8px;
        margin-bottom: 10px;
        padding: 15px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }

    .notification-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .notification-item.unread {
        background-color: #fff8e1;
        border-left: 3px solid #ff7a00;
    }

    .notification-item.fade-out {
        opacity: 0.5;
        transform: translateX(30px);
        transition: opacity 0.5s ease, transform 0.5s ease;
    }

    .notification-icon {
        width: 40px;
        height: 40px;
        background-color: #f5f5f5;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 18px;
    }

    .notification-content {
        flex: 1;
    }

    .notification-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }

    .notification-title {
        font-weight: bold;
    }

    .notification-time {
        color: #666;
        font-size: 12px;
    }

    .notification-message {
        margin-bottom: 5px;
    }

    .notification-link {
        font-size: 14px;
    }

    .notification-link a {
        color: #ff7a00;
        text-decoration: none;
    }

    .notification-link a:hover {
        text-decoration: underline;
    }

    .notification-actions {
        display: flex;
        align-items: flex-start;
    }

    .empty-notification {
        text-align: center;
        padding: 30px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        color: #666;
    }

    .mark-read-btn {
        cursor: pointer;
    }

    .read-indicator {
        color: #4caf50;
        margin: 8px;
        font-size: 16px;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –≤—Å–µ—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
        document.getElementById('markAllReadBtn').addEventListener('click', function(e) {
            e.preventDefault();

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º AJAX-–∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            fetch('{% url "notifications_mark_all_read" %}', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –≤—Å–µ—Ö –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                    document.querySelectorAll('.notification-item.unread').forEach(item => {
                        item.classList.remove('unread');

                        // –ó–∞–º–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–º–µ—Ç–∫–∏ –Ω–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ
                        const actionDiv = item.querySelector('.notification-actions');
                        actionDiv.innerHTML = '<span class="read-indicator" title="–ü—Ä–æ—á–∏—Ç–∞–Ω–æ">‚úì</span>';
                    });

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                    alert('–í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–º–µ—á–µ–Ω—ã –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ.');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.');
            });
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ
        document.querySelectorAll('.mark-read-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();

                const notificationId = this.getAttribute('data-id');
                const notificationItem = document.querySelector(`.notification-item[data-id="${notificationId}"]`);

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º AJAX-–∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                fetch(`/notifications/mark_read/${notificationId}/`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                        notificationItem.classList.add('fade-out');

                        // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ –∫–æ—Ä–æ—Ç–∫–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
                        setTimeout(() => {
                            notificationItem.classList.remove('unread');
                            notificationItem.classList.remove('fade-out');

                            // –ó–∞–º–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–º–µ—Ç–∫–∏ –Ω–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ
                            const actionDiv = notificationItem.querySelector('.notification-actions');
                            actionDiv.innerHTML = '<span class="read-indicator" title="–ü—Ä–æ—á–∏—Ç–∞–Ω–æ">‚úì</span>';
                        }, 300);
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', error);
                });
            });
        });
    });
</script>
{% endblock %}