{% extends 'base.html' %}
{% load static %}

{% block title %}–ì–ª–∞–≤–Ω–∞—è | –û—Ä–∏–æ–Ω{% endblock %}

{% block content %}
<div class="quick-actions">
    <div class="quick-action-card" onclick="location.href='{% url 'ppe_create' %}'">
        <div class="action-icon">üë∑</div>
        <div>
            <h3>–ó–∞—è–≤–∫–∞ –Ω–∞ –°–ò–ó</h3>
            <p>–ó–∞–ø—Ä–æ—Å–∏—Ç—å –°–ò–ó</p>
        </div>
    </div>
    <div class="quick-action-card" onclick="location.href='{% url 'instruction_create' %}'">
        <div class="action-icon">üìù</div>
        <div>
            <h3>–ò–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂</h3>
            <p>–ü—Ä–æ–≤–µ—Å—Ç–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂</p>
        </div>
    </div>
    <div class="quick-action-card" onclick="location.href='{% url 'risk_assessment' %}'">
        <div class="action-icon">‚ö†Ô∏è</div>
        <div>
            <h3>–û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤</h3>
            <p>–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã —Ä–∏—Å–∫–æ–≤</p>
        </div>
    </div>
    <div class="quick-action-card" onclick="location.href='{% url 'notifications' %}'">
        <div class="action-icon">üìä</div>
        <div>
            <h3>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
            <p id="notification-text">{{ notification_count|default:0 }} –Ω–æ–≤—ã—Ö</p>
        </div>
    </div>
</div>

<div class="dashboard-grid">
    <div class="dashboard-card">
        <div class="card-header">
            <div class="card-icon">üìä</div>
            –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        </div>
        <div class="stats-row">
            <div class="stat-box">
                <div class="stat-value" id="incident-days">{{ incident_free_days|default:0 }}</div>
                <div class="stat-label">–î–Ω–µ–π –±–µ–∑ –ø—Ä–æ–∏—Å—à–µ—Å—Ç–≤–∏–π</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="risks-count">{{ identified_risks_count|default:0 }}</div>
                <div class="stat-label">–í—ã—è–≤–ª–µ–Ω–Ω—ã—Ö —Ä–∏—Å–∫–æ–≤</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="compliance">{{ compliance_percentage|default:0 }}%</div>
                <div class="stat-label">–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ</div>
            </div>
        </div>
    </div>

    <div class="dashboard-card">
        <div class="card-header">
            <div class="card-icon">‚ö†Ô∏è</div>
            –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏
        </div>
        <div id="critical-risks">
            {% for risk in critical_risks %}
            <div class="risk-item">
                <a href="{% url 'risk_detail' risk.id %}">
                    {{ risk.hazard.name }} - {{ risk.location|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}
                    <span class="risk-badge risk-{{ risk.level }}">{{ risk.get_level_display }}</span>
                </a>
            </div>
            {% empty %}
            <div class="no-risks">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–∏—Å–∫–æ–≤ –Ω–µ –≤—ã—è–≤–ª–µ–Ω–æ</div>
            {% endfor %}
        </div>
    </div>

    <div class="dashboard-card">
        <div class="card-header">
            <div class="card-icon">üìö</div>
            –î–æ–∫—É–º–µ–Ω—Ç—ã
        </div>
        <div class="dashboard-list">
            {% for document in recent_documents %}
            <div>
                <a href="{% url 'document_detail' document.id %}">
                    {{ document.title }}
                    <span class="list-date">{{ document.updated_at|date:"d.m.Y" }}</span>
                </a>
            </div>
            {% empty %}
            <div>–ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</div>
            {% endfor %}
        </div>
    </div>
</div>

<div class="section-title">–¢–µ–∫—É—â–∏–µ –∑–∞–¥–∞—á–∏ –°–ò–ó</div>
<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                <th>–°–ò–ó</th>
                <th>–î–∞—Ç–∞ –∑–∞—è–≤–∫–∏</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody id="ppe-tasks">
            {% for task in ppe_tasks %}
            <tr>
                <td>#{{ task.id }}</td>
                <td>{{ task.employee.user.last_name }} {{ task.employee.user.first_name }}</td>
                <td>{{ task.ppe_item.name }}</td>
                <td>{{ task.request_date|date:"d.m.Y" }}</td>
                <td>
                    <span class="status-badge status-{{ task.status }}">
                        {% if task.status == 'new' %}–ù–æ–≤–∞—è
                        {% elif task.status == 'in_progress' %}–í –æ–±—Ä–∞–±–æ—Ç–∫–µ
                        {% elif task.status == 'completed' %}–í—ã–ø–æ–ª–Ω–µ–Ω–æ
                        {% else %}{{ task.status }}{% endif %}
                    </span>
                </td>
                <td><a href="{% url 'ppe_detail' task.id %}" class="action-btn">–ü—Ä–æ—Å–º–æ—Ç—Ä</a></td>
            </tr>
            {% empty %}
            <tr><td colspan="6">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á –°–ò–ó</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
// –ü—Ä–æ—Å—Ç–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
function updateStats() {
    fetch('/api/stats/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('incident-days').textContent = data.incident_free_days;
            document.getElementById('risks-count').textContent = data.identified_risks_count;
            document.getElementById('compliance').textContent = data.compliance_percentage + '%';
        })
        .catch(error => console.log('–û—à–∏–±–∫–∞:', error));
}

function updateNotifications() {
    fetch('/api/notifications/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('notification-text').textContent = data.count + ' –Ω–æ–≤—ã—Ö';
        })
        .catch(error => console.log('–û—à–∏–±–∫–∞:', error));
}

// –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(updateStats, 30000);
setInterval(updateNotifications, 15000);
</script>

<style>
.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.quick-action-card {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: transform 0.2s;
}

.quick-action-card:hover {
    transform: translateY(-2px);
}

.action-icon {
    font-size: 24px;
    background: #ff7a00;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.dashboard-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    font-weight: bold;
}

.card-icon {
    font-size: 20px;
    color: #ff7a00;
}

.stats-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
}

.stat-box {
    text-align: center;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
}

.stat-value {
    font-size: 20px;
    font-weight: bold;
    color: #ff7a00;
}

.stat-label {
    font-size: 12px;
    color: #666;
}

.risk-item {
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}

.risk-badge {
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: bold;
    color: white;
}

.risk-high { background: #f44336; }
.risk-critical { background: #9c27b0; }
.risk-medium { background: #ff9800; }
.risk-low { background: #4caf50; }

.status-badge {
    padding: 3px 8px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: bold;
    color: white;
}

.status-new { background: #ff9800; }
.status-in_progress { background: #2196f3; }
.status-completed { background: #4caf50; }

.no-risks {
    color: #4caf50;
    text-align: center;
    padding: 20px;
}
</style>
{% endblock %}