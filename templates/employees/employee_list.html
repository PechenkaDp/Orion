{% extends 'base.html' %}
{% load static %}

{% block title %}–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ | –û—Ä–∏–æ–Ω{% endblock %}

{% block content %}
<div class="page-header">
    <h1>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h1>
    <div class="action-buttons">
        <button class="action-btn" onclick="location.href='{% url 'employee_create' %}'">–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</button>
        {% if is_medical_worker %}
        <button type="button" class="action-btn" id="selectAllBtn">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
        <button type="button" class="action-btn" id="unselectAllBtn">–°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ</button>
        <button type="button" class="action-btn btn-primary" id="sendNotificationsBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
        {% endif %}
    </div>
</div>

<!-- –î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ –≤ filter-bar -->
<div class="filter-bar">
    <form method="get" action="{% url 'employee_list' %}" id="filterForm">
        <div class="filter-group search-group">
            <label for="search">–ü–æ–∏—Å–∫:</label>
            <input type="text" name="search" id="search" class="form-control" value="{{ search_query }}" placeholder="–ò–º—è –∏–ª–∏ —Ñ–∞–º–∏–ª–∏—è">
            <button type="submit" class="search-btn">üîç</button>
        </div>

        <div class="filter-group">
            <label for="department">–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</label>
            <select name="department" id="department" class="form-control">
                <option value="">–í—Å–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è</option>
                {% for dept in departments %}
                <option value="{{ dept.id }}" {% if department_filter == dept.id|stringformat:"i" %}selected{% endif %}>{{ dept.name }}</option>
                {% endfor %}
            </select>
        </div>

        {% if is_medical_worker %}
        <div class="filter-group">
            <label for="medical_status">–°—Ç–∞—Ç—É—Å –º–µ–¥–æ—Å–º–æ—Ç—Ä–∞:</label>
            <select name="medical_status" id="medical_status" class="form-control">
                <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                <option value="overdue" {% if medical_status_filter == 'overdue' %}selected{% endif %}>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</option>
                <option value="warning" {% if medical_status_filter == 'warning' %}selected{% endif %}>–ü—Ä–∏–±–ª–∏–∂–∞—é—â–∏–µ—Å—è (< 5 –¥–Ω–µ–π)</option>
                <option value="upcoming" {% if medical_status_filter == 'upcoming' %}selected{% endif %}>–ë—É–¥—É—â–∏–µ</option>
            </select>
        </div>

        <div class="filter-date-range">
            <label>–î–∞—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ–¥–æ—Å–º–æ—Ç—Ä–∞:</label>
            <div class="date-inputs">
                <input type="date" name="next_exam_from" class="form-control" value="{{ next_exam_from }}" placeholder="–û—Ç">
                <span>‚Äî</span>
                <input type="date" name="next_exam_to" class="form-control" value="{{ next_exam_to }}" placeholder="–î–æ">
            </div>
        </div>
        {% endif %}

        <div class="filter-buttons">
            <button type="submit" class="action-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <button type="button" class="btn-secondary" onclick="clearFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
    </form>
</div>

{% if is_medical_worker %}
<form method="post" id="notificationForm" action="{% url 'send_medical_notifications' %}">
    {% csrf_token %}
{% endif %}

<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                {% if is_medical_worker %}
                <th class="checkbox-column"><input type="checkbox" id="selectAll"></th>
                {% endif %}
                <th>–§–ò–û</th>
                <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
                <th>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</th>
                <th>–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞</th>
                <th>–°–ª–µ–¥—É—é—â–∏–π –º–µ–¥–æ—Å–º–æ—Ç—Ä</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for employee in page_obj %}
            <tr class="{% if employee.medical_status == 'overdue' %}medical-overdue{% elif employee.medical_status == 'warning' %}medical-warning{% endif %}">
                {% if is_medical_worker %}
                <td><input type="checkbox" name="selected_employees" value="{{ employee.id }}" class="employee-checkbox"></td>
                {% endif %}
                <td>{{ employee.user.last_name }} {{ employee.user.first_name }}</td>
                <td>{{ employee.position }}</td>
                <td>{{ employee.department.name }}</td>
                <td>{{ employee.hire_date|date:"d.m.Y" }}</td>
                <td class="{% if employee.medical_status == 'overdue' %}overdue{% elif employee.medical_status == 'warning' %}warning{% endif %}">
                    {{ employee.next_medical_exam_date|date:"d.m.Y"|default:"–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω" }}
                </td>
                <td>
                    <span class="status-badge {% if employee.user.is_active %}status-active{% else %}status-inactive{% endif %}">
                        {% if employee.user.is_active %}–ê–∫—Ç–∏–≤–µ–Ω{% else %}–ù–µ–∞–∫—Ç–∏–≤–µ–Ω{% endif %}
                    </span>

                    {% if employee.medical_status == 'overdue' %}
                    <span class="status-badge status-urgent" title="–ü—Ä–æ—Å—Ä–æ—á–µ–Ω –º–µ–¥–æ—Å–º–æ—Ç—Ä">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω</span>
                    {% elif employee.medical_status == 'warning' %}
                    <span class="status-badge status-warning" title="–ü—Ä–∏–±–ª–∏–∂–∞–µ—Ç—Å—è –º–µ–¥–æ—Å–º–æ—Ç—Ä">< 5 –¥–Ω–µ–π</span>
                    {% endif %}
                </td>
                <td>
                    <a href="{% url 'employee_detail' employee.id %}" class="icon-btn" title="–ü—Ä–æ—Å–º–æ—Ç—Ä"><span class="btn-icon">üëÅÔ∏è</span></a>
                    <a href="{% url 'employee_update' employee.id %}" class="icon-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"><span class="btn-icon">‚úèÔ∏è</span></a>
                    {% if is_medical_worker %}
                    <a href="{% url 'medical_exam_create' employee.id %}" class="icon-btn" title="–ù–∞–∑–Ω–∞—á–∏—Ç—å –º–µ–¥–æ—Å–º–æ—Ç—Ä"><span class="btn-icon">üè•</span></a>
                    {% endif %}
                    <a href="{% url 'employee_delete' employee.id %}" class="icon-btn" title="–£–¥–∞–ª–∏—Ç—å"><span class="btn-icon">üóëÔ∏è</span></a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="{% if is_medical_worker %}8{% else %}7{% endif %}" class="empty-table">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if is_medical_worker %}
</form>
{% endif %}

{% include 'partials/pagination.html' with page=page_obj %}

<style>
    .status-active {
        background-color: #e6f7e6;
        color: #4caf50;
    }
    .status-inactive {
        background-color: #ffe6e6;
        color: #f44336;
    }
    .status-urgent {
        background-color: #f44336;
        color: white;
    }
    .status-warning {
        background-color: #ff9800;
        color: white;
    }
    .medical-overdue {
        background-color: rgba(244, 67, 54, 0.1);
    }
    .medical-warning {
        background-color: rgba(255, 152, 0, 0.1);
    }
    .overdue {
        color: #f44336;
        font-weight: bold;
    }
    .warning {
        color: #ff9800;
        font-weight: bold;
    }
    .checkbox-column {
        width: 40px;
    }
    .filter-date-range {
        display: flex;
        flex-direction: column;
        margin-right: 15px;
    }
    .date-inputs {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .date-inputs input {
        width: 140px;
    }
    .filter-buttons {
        display: flex;
        align-items: flex-end;
        gap: 10px;
    }
    #notificationForm {
        margin-bottom: 0;
    }
    .search-group {
        display: flex;
        align-items: center;
        gap: 5px;
        min-width: 250px;
    }

    .search-group input {
        flex-grow: 1;
        margin-right: 0;
    }

    .search-btn {
        background-color: #ff7a00;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 12px;
        cursor: pointer;
    }

    .search-btn:hover {
        background-color: #e66d00;
    }

    .filter-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: flex-end;
        margin-bottom: 20px;
    }

    @media (max-width: 768px) {
        .filter-bar {
            flex-direction: column;
            align-items: stretch;
        }

        .search-group {
            width: 100%;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        document.getElementById('resetFilters').addEventListener('click', function() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã
            document.getElementById('filterForm').reset();
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('filterForm').submit();
        });

        {% if is_medical_worker %}
        // –ì–ª–∞–≤–Ω—ã–π —á–µ–∫–±–æ–∫—Å "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"
        const selectAllCheckbox = document.getElementById('selectAll');
        const employeeCheckboxes = document.querySelectorAll('.employee-checkbox');

        selectAllCheckbox.addEventListener('change', function() {
            employeeCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        });

        // –ö–Ω–æ–ø–∫–∞ "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"
        document.getElementById('selectAllBtn').addEventListener('click', function() {
            selectAllCheckbox.checked = true;
            employeeCheckboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
        });

        // –ö–Ω–æ–ø–∫–∞ "–°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ"
        document.getElementById('unselectAllBtn').addEventListener('click', function() {
            selectAllCheckbox.checked = false;
            employeeCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        });

        // –ö–Ω–æ–ø–∫–∞ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
        document.getElementById('sendNotificationsBtn').addEventListener('click', function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å–æ—Ç—Ä—É–¥–Ω–∏–∫
            const selectedCount = Array.from(employeeCheckboxes).filter(cb => cb.checked).length;

            if (selectedCount === 0) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
                return;
            }

            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –º–µ–¥–æ—Å–º–æ—Ç—Ä–µ ${selectedCount} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º?`)) {
                document.getElementById('notificationForm').submit();
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        document.querySelectorAll('#filterForm select, #filterForm input').forEach(element => {
            element.addEventListener('change', function() {
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª—é–±–æ–≥–æ –ø–æ–ª—è (–∫—Ä–æ–º–µ –¥–∞—Ç)
                if (!element.type || element.type !== 'date') {
                    document.getElementById('filterForm').submit();
                }
            });
        });
        {% endif %}
    });
</script>
{% endblock %}